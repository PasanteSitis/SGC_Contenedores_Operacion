services:
  db:
    image: postgres:18
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - db_data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
    ports:
      - "5432:5432"

  redis:
    image: redis:alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data

  nextcloud:
    image: nextcloud:latest
    restart: always
    ports:
      - "8080:80"
    environment:
      POSTGRES_HOST: db
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      NEXTCLOUD_USER: ${POSTGRES_USER}
      NEXTCLOUD_PASS: ${POSTGRES_PASSWORD}
      NEXTCLOUD_URL: ${NEXTCLOUD_URL}
      REDIS_HOST: redis
    volumes:
      - nextcloud_data:/var/www/html
      - git_work:/var/www/html/data/__groupfolders/1/files:rw
      - ./logs/nextcloud/apache:/var/log/apache2
      - ./apache/logging.conf:/etc/apache2/conf-available/logging.conf:ro
    depends_on:
      - db
      - redis
      - collabora
    healthcheck:
      test: ["CMD", "curl -fsS --max-time 5 http://localhost:80/status.php || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  collabora:
    image: collabora/code 
    environment:
      domain: nextcloud|localhost|127\.0\.0\.1|app|host\.docker\.internal
      username: ${COLLABORA_USER}
      password: ${COLLABORA_PASS}
      ssl.enable: "false"
      user_interface.use_integration_theme: "false"
      NEXTCLOUD_URL: ${NEXTCLOUD_URL}
    ports:
      - "9980:9980"
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS --max-time 7 http://localhost:9980/hosting/ || exit 1"]
      interval: 15s
      timeout: 7s
      retries: 10

  sync_batch:
    build:
      context: ./sync
      dockerfile: Dockerfile
    image: nextcloud_sync:local
    container_name: nextcloud_git_sync
    restart: unless-stopped
    user: "33:33"
    volumes:
      - git_work:/repo:rw                 
      - ./sync:/sync:ro   
    env_file:
      - .env
    environment:
      - GIT_USER=${GIT_USER}
      - GIT_TOKEN=${GIT_TOKEN}
      - GIT_REPO=${GIT_REPO}
      - GIT_BRANCH=${GIT_BRANCH:-master}
      - REPO_DIR=/repo
      - SYNC_INTERVAL=${SYNC_INTERVAL:-300}
      - NEXTCLOUD_URL=${NEXTCLOUD_URL}
      - NEXTCLOUD_API_USER=${NEXTCLOUD_API_USER}
      - NEXTCLOUD_API_PASS=${NEXTCLOUD_API_PASS}
      - NEXTCLOUD_START_DIR=${NEXTCLOUD_START_DIR}
      - EDITOR_CACHE_TTL=${EDITOR_CACHE_TTL:-600}
      - EMAIL_DOMAIN=${EMAIL_DOMAIN:-sitis.com.com}
      - DB_HOST=db
      - DB_PORT=5432
      - DB_NAME=${POSTGRES_DB}
      - DB_USER=${POSTGRES_USER}
      - DB_PASS=${POSTGRES_PASSWORD}
    entrypoint: ["sh","-c"]
    command: ["/sync/sync_daemon.sh"]
    depends_on:
      - nextcloud
      - db

  audit:
    build:
      context: ./audit
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - DB_HOST=db
      - NEXTCLOUD_LOG_PATH=/var/log/apache2/access.log
      - NEXTCLOUD_APP_LOG=/var/www/html/data/nextcloud/nextcloud.log
      - DOCKER_SOCK=0           # poner 1 para habilitar docker logs fallback
      - NEXTCLOUD_CONTAINER=nextcloud
      - DEDUPE_SECONDS=2
      - CORRELATION_WINDOW=30
    volumes:
      - ./logs/nextcloud/apache:/var/log/apache2:ro    # preferible: apache writes here
      - nextcloud_data:/var/www/html:ro               # read-only to access nextcloud.log
      - ./audit:/opt/audit:ro
    depends_on:
      - db
      - nextcloud

  sidecar:
    build:
      context: ./sidecar
      dockerfile: Dockerfile
    image: nextcloud_sidecar:local
    container_name: nextcloud_sidecar
    restart: unless-stopped
    user: "33:33" 
    environment:
      - ROOT_DIR=/repo
      - RUN_INTERVAL=1500        # segundos
      - GIT_COMMIT=0            # 0 = no hace commit (sync_batch lo har√°); 1 = hace commit
      - GIT_USER=sidecar-bot
      - GIT_EMAIL=sidecar@local
      - GIT_BRANCH=master
    volumes:
      - git_work:/repo:rw                # mount same place where sync_batch uses repo
      - nextcloud_data:/var/www/html:ro  # lectura si necesitas (opcional)
      - ./sidecar:/opt/sidecar:ro        # copia de scripts (lectura)
    depends_on:
      - db
      - nextcloud
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

volumes:
  db_data:
  nextcloud_data:
  git_clone:
  git_work:
  redis_data: